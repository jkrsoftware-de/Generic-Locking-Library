# Unite GDPR-Service Gitlab-CI Pipeline Configuration
image: docker:latest
services:
  - docker:dind

# Pipeline Variables
variables:
  DOCKER_TLS_CERTDIR: ''
  DOCKER_DRIVER: overlay2
  SPRING_PROFILES_ACTIVE: gitlab-ci

# Pipeline Stages
stages:
  - build
  - prepare-new-version
  - development-release-to-stage03
  - create-new-version
  - create-merge-request-for-new-version
  - manual-deploy-approval
  - deploy

### Maven: Build & Test Application ###

# Try to build application.
maven-build:
  stage: build
  image: maven:3.8-openjdk-11-slim
  allow_failure: false
  cache:
    paths:
      - '.m2/'
  script: "mvn clean package -B"
  artifacts:
    paths:
      - target/*.jar

# Run all tests.
maven-test:
  stage: build
  image: maven:3.8-openjdk-11-slim
  allow_failure: false
  cache:
    paths:
      - '.m2/'
  artifacts:
    paths:
      - target/*.jar
  script: "mvn clean test verify"

### prepare new Version-Creation ###

# Job for Creating new Service-Versions from a Commit.
create-new-deployable-version:
  stage: prepare-new-version
  image: maven:3.8-openjdk-11-slim
  allow_failure: false
  when: manual
  only:
    - /^main$/
  script:
    #
    - release-scripts/gitlab/create-new-deployable-version.sh